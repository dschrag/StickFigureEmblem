<html>
<head>
    <title>Stick FIguRE EMBLEM Game</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link rel=stylesheet href="css/base.css" />
</head>
<body>
    <script src="js/three.min.js"></script>
    <script src="js/Three.js"></script>
    <script src="js/Detector.js"></script>
    <script src="js/Stats.js"></script>
    <script src="js/OrbitControls.js"></script>
    <script src="js/KeyboardState.js"></script>
    <script src="js/THREEx.FullScreen.js"></script>
    <script src="js/THREEx.WindowResize.js"></script>
    <script type="text/javascript" src="js/Unit.js"></script>


    <script src="js/jquery-1.9.1.js"></script>
    <script src="js/jquery-ui.js"></script>
    <link rel=stylesheet href="css/jquery-ui.css" />
    <link rel=stylesheet href="css/info.css" />
    <script src="js/info.js"></script>


    <div id="ThreeJS" style="position: absolute; left:0px; top:0px"></div>

    <script>
        // main
        var container, scene, camera, renderer, mesh, controls;
        var models = new Array();
        var modelIndex = 0;
        var currentModel;

        var posx = 0;
        var posy = 0;
        var posz = 0;

        var keyboard = new KeyboardState();
        var clock = new THREE.Clock();

        var projector, mouse = {x: 0, y: 0};
        var targetlist = [];
        var unitArray = new Array;
        var unitIndex = 0;

        init();
        animate();

        // initializing stuff
        function init()
        {
            // creating a new scene
            scene = new THREE.Scene();
            THREE.ImageUtils.crossOrigin = '';
            // setting up camera
            var SCREEN_WIDTH = window.innerWidth, SCREEN_HEIGHT = window.innerHeight;
            var VIEW_ANGLE = 60, ASPECT = 1.5 *( SCREEN_WIDTH / SCREEN_HEIGHT ), NEAR = 0.1, FAR = 20000;
            camera = new THREE.PerspectiveCamera(VIEW_ANGLE, ASPECT, NEAR, FAR);
            scene.add(camera);
            camera.position.set(0, 650, -675);
            camera.lookAt(scene.position);


            // set up renderer
            if (Detector.webgl)
            {
                renderer = new THREE.WebGLRenderer({ antialias: true });
            }
            else
            {
                renderer = new THREE.CanvasRenderer();
            }
            renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
            container = document.getElementById('ThreeJS');
            container.appendChild(renderer.domElement);

            // setup Events
            THREEx.WindowResize(renderer, camera);


            // setup controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);


            // set up light
            var light = new THREE.PointLight(0xffffff);
            light.position.set(0, 250, 0);
            scene.add(light);

            //floor
            var floorTexture = new THREE.ImageUtils.loadTexture('images/grasschecker.jpg');
            floorTexture.wrapS = floorTexture.wrapT = THREE.RepeatWrapping;
            floorTexture.repeat.set(10, 10);
            var floorMaterial = new THREE.MeshBasicMaterial( {map: floorTexture, side: THREE.DoubleSide} );
            var floorWireframe = new THREE.MeshBasicMaterial( {color: 0x00ee00, wireframe: true, transparant: true} );
	        var floorMaterials = [floorMaterial, floorWireframe];

	        var floorGeometry = new THREE.PlaneGeometry(1000, 1000, 10, 10);

	        var floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.position.y = -0.5;
            floor.rotation.x = Math.PI / 2;
            scene.add(floor);


            // setup skybox
            var image = "images/forest.jpg";
            var materialArray = [];
            for (var i = 0; i < 6; i++)
                materialArray.push(new THREE.MeshBasicMaterial({
                    map: THREE.ImageUtils.loadTexture(image),
                    side: THREE.BackSide
                }));
            var skyMaterial = new THREE.MeshFaceMaterial(materialArray);
            var skyGeometry = new THREE.CubeGeometry(10000, 10000, 10000);
            var skyBox = new THREE.Mesh(skyGeometry, skyMaterial);

            scene.add(skyBox);

            projector = new THREE.Projector();


            // loading in initial models.
            var jsonloader = new THREE.JSONLoader();
            jsonloader.load("models/stickfigurewarrior.json", addModelToScene);
            console.log("Unit array length " + unitArray.length);
            console.log("Unit index: " + unitIndex);

            jsonloader.load("models/stickfiguremage.json", addModelToScene);

            jsonloader.load("models/stickfigureranger.json", addModelToScene);
            //targetlist[2].unit = new Unit("ranger");
            console.log("Number of models " + targetlist.length);
            document.addEventListener('mousedown', eventClicked, false);
            console.log("CurrentModel " + currentModel);
        }

        function eventClicked(event)
        {
            console.log("Clicked on something");

            // update "mouse"
            mouse.x = (event.clientX / innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / innerHeight) * 2 + 1;

            //finding interactions
            var vector = new THREE.Vector3(mouse.x, mouse.y, 1);
            projector.unprojectVector(vector, camera);
            var ray = new THREE.Raycaster(camera.position, vector.sub(camera.position).normalize());

            var intersections = ray.intersectObjects(targetlist);

            if (intersections.length > 0 )
            {
                // part of the target list of units.
                console.log("Clicked a model");
                currentModel = intersections[0];

                // spawn GUI here


            }
            else
            {
                console.log("clicked on something else");
            }
            console.log("CurrentModel after init " + currentModel);
        }

        // adding models
        function addModelToScene(geometry, materials)
        {
            var material = new THREE.MeshFaceMaterial(materials);
            models[modelIndex] = new THREE.Mesh(geometry, material);
            models[modelIndex].scale.set(10, 10, 10);
            // 25 and 20 are the magic numbers that set the units in the proper positions.
            models[modelIndex].position.set(25 + posx, 0 + posy, 25 + posz);
            var unit = new Unit("warrior");
            unit.setModel(models[modelIndex]);
            unitArray.push(unit)
            unitIndex++;
            targetlist.push(models[modelIndex]);
            scene.add(models[modelIndex]);
            modelIndex++;
            posx += 100;
            posz += 100;

        }

        // will do our rendering.
        function animate()
        {
            requestAnimationFrame(animate);
            render();
            update();

        }

        function render()
        {
            renderer.render(scene, camera);
        }

        function update()
        {
            if (keyboard.pressed("z"))
            {
                // do something
            }
            controls.update();
            //stats.update();
        }

    </script>
</body>
</html>
